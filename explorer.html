<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BÆKON Research Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Red+Hat+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        .font-display { font-family: 'Red Hat Display', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .text-neon-blue { color: #39d8ff; text-shadow: 0 0 10px rgba(57, 216, 255, 0.5); }
        .text-neon-purple { color: #a855f7; text-shadow: 0 0 10px rgba(168, 85, 247, 0.5); }
        .text-terminal-green { color: #39ff14; text-shadow: 0 0 8px rgba(57, 255, 20, 0.6); }
        .terminal-text { color: #39ff14; font-family: 'JetBrains Mono', monospace; }
        
        .cyber-border {
            @apply border border-gray-600 rounded-lg bg-black/40 backdrop-blur-sm;
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.6), rgba(16, 16, 24, 0.8));
            border: 1px solid rgba(168, 85, 247, 0.3);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .cyber-button {
            @apply bg-purple-600/30 hover:bg-purple-500/50 border border-purple-400 px-4 py-2 rounded font-display text-purple-100 transition-all duration-200;
        }
        
        .cyber-input {
            @apply bg-black/50 border border-gray-600 rounded px-3 py-2 text-white placeholder-gray-400 focus:border-purple-400 focus:ring-1 focus:ring-purple-400/50 outline-none transition-all;
        }
        
        body {
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            color: #e4e4e7;
            font-family: 'Red Hat Display', sans-serif;
        }
        
        .status-indicator {
            position: relative;
        }
        
        .status-indicator.online::after {
            content: "●";
            color: #39ff14;
            animation: pulse 2s infinite;
            margin-left: 8px;
        }
        
        .status-indicator.offline::after {
            content: "●";
            color: #ef4444;
            margin-left: 8px;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="min-h-screen text-zinc-100">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // API Base URL
        const API_BASE = 'http://127.0.0.1:8787';

        // API Status Hook
        function useAPIStatus() {
            const [isOnline, setIsOnline] = useState(false);
            
            useEffect(() => {
                const checkAPI = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/lexicon/search?q=test`);
                        setIsOnline(response.ok);
                    } catch (error) {
                        setIsOnline(false);
                    }
                };
                
                checkAPI();
                const interval = setInterval(checkAPI, 30000); // Check every 30s
                return () => clearInterval(interval);
            }, []);
            
            return isOnline;
        }

        // Ana's Index Component
        function AnaIndex() {
            const [query, setQuery] = useState("");
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(false);
            const [openItem, setOpenItem] = useState(null);

            const search = async () => {
                if (!query.trim()) return;
                setLoading(true);
                try {
                    const params = new URLSearchParams({
                        q: query,
                        fields: 'title,english_text,full_text',
                        from: '2000-01-01',
                        to: new Date().toISOString().slice(0, 10)
                    });
                    const response = await fetch(`${API_BASE}/anas-index/search?${params}`);
                    const data = await response.json();
                    setResults(data || []);
                } catch (error) {
                    console.error('Ana Index search failed:', error);
                    setResults([]);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="space-y-3">
                    <div className="flex space-x-2">
                        <input
                            type="text"
                            value={query}
                            onChange={(e) => setQuery(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && search()}
                            placeholder="Search FL documents..."
                            className="cyber-input flex-1 text-sm"
                        />
                        <button onClick={search} disabled={loading} className="cyber-button text-sm">
                            {loading ? 'Searching...' : 'Search'}
                        </button>
                    </div>
                    
                    <div className="cyber-border max-h-64 overflow-y-auto">
                        {results.length === 0 ? (
                            <div className="p-4 text-center text-zinc-400 text-sm">
                                {loading ? 'Searching...' : 'No results'}
                            </div>
                        ) : (
                            results.map((result, i) => (
                                <div key={i} className="border-b border-white/5 last:border-b-0">
                                    <div 
                                        className="p-3 cursor-pointer hover:bg-white/5 transition-colors"
                                        onClick={() => setOpenItem(openItem === i ? null : i)}
                                    >
                                        <div className="font-mono text-zinc-100 text-sm">{result.title || "Untitled"}</div>
                                        <div className="text-xs text-zinc-400 mt-1">
                                            {result.author || "Unknown"} • {result.date_posted?.slice(0, 10) || "No date"}
                                        </div>
                                    </div>
                                    {openItem === i && (
                                        <div className="p-3 bg-black/20 border-t border-white/5">
                                            {result.english_text && (
                                                <div className="mb-2">
                                                    <div className="text-xs text-purple-400 mb-1">English Abstract:</div>
                                                    <div className="text-sm text-zinc-200">{result.english_text}</div>
                                                </div>
                                            )}
                                            {result.full_text && (
                                                <div>
                                                    <div className="text-xs text-purple-400 mb-1">FL Text:</div>
                                                    <div className="text-sm text-zinc-200 font-mono">{result.full_text}</div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        }

        // Lexicon Search Component
        function LexiconSearch() {
            const [query, setQuery] = useState("");
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(false);

            const search = async () => {
                if (!query.trim()) return;
                setLoading(true);
                try {
                    const response = await fetch(`${API_BASE}/lexicon/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    setResults(data || []);
                } catch (error) {
                    console.error('Lexicon search failed:', error);
                    setResults([]);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="space-y-3">
                    <div className="flex space-x-2">
                        <input
                            type="text"
                            value={query}
                            onChange={(e) => setQuery(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && search()}
                            placeholder="Search FL lexicon..."
                            className="cyber-input flex-1 text-sm"
                        />
                        <button onClick={search} disabled={loading} className="cyber-button text-sm">
                            {loading ? 'Searching...' : 'Search'}
                        </button>
                    </div>
                    
                    <div className="cyber-border max-h-40 overflow-y-auto">
                        {results.length === 0 ? (
                            <div className="p-4 text-center text-zinc-400 text-sm">
                                {loading ? 'Searching...' : 'No results'}
                            </div>
                        ) : (
                            results.map((result, i) => (
                                <div key={i} className="p-2 border-b border-white/5 last:border-b-0">
                                    <div className="flex justify-between items-center">
                                        <span className="font-mono text-neon-blue text-sm">{result.surface_form}</span>
                                        <span className="text-zinc-300 text-sm">{result.gloss}</span>
                                    </div>
                                    {result.confidence && (
                                        <div className="text-xs text-zinc-500 mt-1">
                                            Confidence: {Math.round(result.confidence * 100)}%
                                        </div>
                                    )}
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        }

        // FL Translation Chat
        function FLTranslationChat() {
            const [messages, setMessages] = useState([]);
            const [currentMessage, setCurrentMessage] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const chatRef = useRef(null);

            const sendMessage = async () => {
                if (!currentMessage.trim() || isLoading) return;

                const userMessage = {
                    id: Date.now(),
                    type: 'user',
                    content: currentMessage,
                    timestamp: new Date()
                };

                setMessages(prev => [...prev, userMessage]);
                setCurrentMessage('');
                setIsLoading(true);

                try {
                    // Call the live translation API
                    const response = await fetch(`${API_BASE}/translate/research`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            span_id: '07f94cc1-f652-40d0-95ec-f86ad20228a7', // Test span
                            model: 'claude-3-5-sonnet-20241022'
                        })
                    });

                    const result = await response.json();
                    
                    const aiMessage = {
                        id: Date.now() + 1,
                        type: 'ai',
                        content: formatTranslationResult(result, userMessage.content),
                        timestamp: new Date()
                    };

                    setMessages(prev => [...prev, aiMessage]);
                } catch (error) {
                    const errorMessage = {
                        id: Date.now() + 1,
                        type: 'ai',
                        content: `❌ Translation API error: ${error.message}`,
                        timestamp: new Date()
                    };
                    setMessages(prev => [...prev, errorMessage]);
                } finally {
                    setIsLoading(false);
                }
            };

            const formatTranslationResult = (result, originalText) => {
                if (typeof result === 'string') {
                    try {
                        result = JSON.parse(result);
                    } catch {
                        return `Analysis result: ${result}`;
                    }
                }

                let output = `🔬 BÆKON FL Analysis of "${originalText}":\n\n`;
                
                if (result.tokens && result.tokens.length > 0) {
                    output += `🧩 Token Analysis (${result.tokens.length} tokens identified):\n`;
                    result.tokens.forEach(token => {
                        output += `• ${token.surface} → "${token.gloss}" (${Math.round((token.confidence || 0) * 100)}% confidence)\n`;
                        if (token.sources && token.sources.length > 0) {
                            output += `  📚 Source: ${token.sources[0]}\n`;
                        }
                    });
                    output += '\n';
                }

                if (result.provenance) {
                    output += `📊 Analysis Details:\n`;
                    output += `• Model: ${result.provenance.model}\n`;
                    output += `• Mode: ${result.mode}\n`;
                    if (result.notes) {
                        output += `• Notes: ${result.notes}\n`;
                    }
                }

                return output;
            };

            useEffect(() => {
                if (chatRef.current) {
                    chatRef.current.scrollTop = chatRef.current.scrollHeight;
                }
            }, [messages]);

            return (
                <div className="space-y-3">
                    <div 
                        ref={chatRef}
                        className="cyber-border p-4 h-48 overflow-y-auto space-y-3"
                    >
                        {messages.length === 0 ? (
                            <div className="text-center text-zinc-400 text-sm">
                                Enter FL text below for real-time analysis...
                            </div>
                        ) : (
                            messages.map(message => (
                                <div key={message.id} className={`p-3 rounded-lg ${
                                    message.type === 'user' 
                                        ? 'bg-purple-600/20 border border-purple-400/30 ml-8' 
                                        : 'bg-blue-600/20 border border-blue-400/30 mr-8'
                                }`}>
                                    <div className="text-sm whitespace-pre-wrap">{message.content}</div>
                                    <div className="text-xs text-zinc-400 mt-2">
                                        {message.timestamp.toLocaleTimeString()}
                                    </div>
                                </div>
                            ))
                        )}
                        {isLoading && (
                            <div className="text-center">
                                <div className="text-sm text-purple-400 animate-pulse">
                                    Analyzing FL text...
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <div className="flex space-x-2">
                        <input
                            type="text"
                            value={currentMessage}
                            onChange={(e) => setCurrentMessage(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                            placeholder="Enter FL text for analysis..."
                            className="cyber-input flex-1"
                            disabled={isLoading}
                        />
                        <button 
                            onClick={sendMessage} 
                            disabled={isLoading || !currentMessage.trim()}
                            className="cyber-button"
                        >
                            {isLoading ? 'Analyzing...' : 'Send'}
                        </button>
                    </div>
                </div>
            );
        }

        // Main Explorer App
        function ExplorerApp() {
            const apiOnline = useAPIStatus();

            const flLanguages = [
                { lang: "UIFAIN", status: "active", color: "text-terminal-green" },
                { lang: "FEB", status: "parsing", color: "text-yellow-400" },
                { lang: "AIFUR", status: "standby", color: "text-zinc-400" },
                { lang: "AITEJE", status: "error", color: "text-red-400" },
                { lang: "AEI", status: "active", color: "text-terminal-green" },
                { lang: "UILAIN", status: "standby", color: "text-zinc-400" },
                { lang: "UILAUD", status: "active", color: "text-terminal-green" },
                { lang: "EILAIU", status: "parsing", color: "text-yellow-400" },
                { lang: "EIEIE", status: "standby", color: "text-zinc-400" },
                { lang: "NIJON", status: "active", color: "text-terminal-green" },
                { lang: "AIESU", status: "standby", color: "text-zinc-400" },
            ];

            return (
                <div className="min-h-screen p-4">
                    {/* Header */}
                    <header className="cyber-border p-6 mb-4">
                        <div className="flex justify-between items-center">
                            <div>
                                <h1 className="text-3xl font-bold font-display text-neon-blue">
                                    BÆKON RZRCT
                                </h1>
                                <p className="text-zinc-400 mt-1">Forgotten Languages Research Console</p>
                            </div>
                            <div className={`status-indicator ${apiOnline ? 'online' : 'offline'}`}>
                                <span className="text-sm">API Status: </span>
                                <span className={apiOnline ? 'text-terminal-green' : 'text-red-400'}>
                                    {apiOnline ? 'ONLINE' : 'OFFLINE'}
                                </span>
                            </div>
                        </div>
                    </header>

                    {/* Main Content Grid */}
                    <div className="grid grid-cols-[300px_1fr_400px] gap-4 h-[calc(100vh-200px)]">
                        
                        {/* Left Sidebar - FL Languages */}
                        <aside className="cyber-border space-y-3 p-4">
                            <h2 className="text-lg font-semibold font-display text-neon-blue border-b border-cyan-400/30 pb-2">
                                FL CORPUS
                            </h2>
                            <div className="space-y-2 text-sm">
                                {flLanguages.map((lang, i) => (
                                    <div key={i} className="flex items-center justify-between hover:bg-white/5 p-2 rounded">
                                        <span className={`font-mono ${lang.color}`}>{lang.lang}</span>
                                        <div className={`w-2 h-2 rounded-full ${
                                            lang.status === 'active' ? 'bg-terminal-green animate-pulse shadow-[0_0_8px_rgba(57,255,20,0.6)]' :
                                            lang.status === 'parsing' ? 'bg-yellow-400 animate-pulse shadow-[0_0_8px_rgba(255,255,0,0.6)]' :
                                            lang.status === 'error' ? 'bg-red-400 shadow-[0_0_8px_rgba(255,0,0,0.6)]' :
                                            'bg-zinc-600'
                                        }`}></div>
                                    </div>
                                ))}
                            </div>
                        </aside>

                        {/* Center Content */}
                        <main className="space-y-4 overflow-auto">
                            {/* Research Console */}
                            <div className="cyber-border p-6">
                                <h2 className="text-xl font-semibold font-display text-neon-blue mb-4">Research Console</h2>
                                
                                {/* Analysis Grid */}
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <div className="cyber-border p-4">
                                        <h3 className="text-lg mb-3 font-display text-neon-blue">Ana's Index</h3>
                                        <AnaIndex />
                                    </div>
                                    
                                    <div className="cyber-border p-4">
                                        <h3 className="text-lg mb-3 font-display text-neon-blue">FL Lexicon</h3>
                                        <LexiconSearch />
                                    </div>
                                </div>
                            </div>

                            {/* FL Translation Console */}
                            <div className="cyber-border p-6">
                                <h3 className="text-lg mb-3 font-display text-neon-purple">FL Translation Console</h3>
                                <FLTranslationChat />
                            </div>
                        </main>

                        {/* Right Sidebar - Provenance */}
                        <aside className="cyber-border p-4">
                            <h2 className="text-lg font-semibold font-display text-neon-purple border-b border-purple-500/30 pb-2 mb-4">
                                PROVENANCE
                            </h2>
                            
                            <div className="space-y-4 text-sm">
                                <div className="cyber-border p-3 bg-black/20">
                                    <h4 className="text-purple-400 mb-2 font-display">Current Analysis</h4>
                                    <div className="space-y-2">
                                        <div className="flex justify-between">
                                            <span className="text-zinc-400">Model:</span>
                                            <span className="terminal-text">claude-3-5-sonnet</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-zinc-400">Sources:</span>
                                            <span className="text-blue-400">3 active</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-zinc-400">Confidence:</span>
                                            <span className="text-terminal-green">94.2%</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="cyber-border p-3 bg-black/20">
                                    <h4 className="text-purple-400 mb-2 font-display">Source Chain</h4>
                                    <div className="space-y-1 text-xs">
                                        <div className="text-terminal-green">✓ stones-seed@local</div>
                                        <div className="text-terminal-green">✓ ana-index@db</div>
                                        <div className="text-yellow-400">⧗ fl-community@web</div>
                                        <div className="text-zinc-600">○ cassini-coords@verify</div>
                                    </div>
                                </div>

                                <div className="cyber-border p-3 bg-black/20">
                                    <h4 className="text-purple-400 mb-2 font-display">Research Notes</h4>
                                    <div className="text-xs text-zinc-400 space-y-2">
                                        <div>• Corpus analysis in progress</div>
                                        <div>• 21.9MB Ana's Index loaded</div>
                                        <div>• FL lexicon: 2,447 entries</div>
                                        <div>• Translation confidence: High</div>
                                    </div>
                                </div>
                            </div>
                        </aside>
                    </div>
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<ExplorerApp />, document.getElementById('root'));
    </script>
</body>
</html>
