<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√ÜKON Research Console - Live Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Red+Hat+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cal+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            font-family: 'Cal Sans', 'Red Hat Display', 'JetBrains Mono', monospace;
        }

        body {
            background: 
                radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 255, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 105, 180, 0.1) 0%, transparent 50%),
                repeating-linear-gradient(0deg, transparent 0px, rgba(255, 255, 255, 0.03) 1px, transparent 2px),
                repeating-linear-gradient(90deg, transparent 0px, rgba(255, 255, 255, 0.03) 1px, transparent 2px),
                linear-gradient(135deg, #0a0b0d 0%, #14161a 100%);
            background-size: 
                800px 800px,
                800px 800px, 
                600px 600px,
                100px 100px,
                100px 100px,
                cover;
            background-attachment: fixed;
        }

        .cyber-border {
            border: 2px solid rgba(0, 255, 255, 0.6);
            background: rgba(10, 11, 13, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 12px;
            position: relative;
            box-shadow: 
                0 0 20px rgba(0, 255, 255, 0.4),
                inset 0 0 20px rgba(0, 255, 255, 0.1);
        }

        .cyber-button {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.6) 0%, rgba(0, 255, 255, 0.6) 100%);
            border: 2px solid rgba(0, 255, 255, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cyber-button:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.8) 0%, rgba(0, 255, 255, 0.8) 100%);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
            transform: translateY(-2px);
        }

        .cyber-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .cyber-input {
            background: rgba(10, 11, 13, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.3s ease;
        }

        .cyber-input:focus {
            outline: none;
            border-color: rgba(0, 255, 255, 0.8);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
        }

        .cyber-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin: 4px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: rgba(255, 255, 255, 0.8);
            font-family: 'JetBrains Mono', monospace;
        }

        .sidebar-item:hover {
            background: rgba(0, 255, 255, 0.1);
            color: rgba(0, 255, 255, 0.9);
        }

        .sidebar-item.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3) 0%, rgba(0, 255, 255, 0.3) 100%);
            color: white;
            border: 1px solid rgba(0, 255, 255, 0.5);
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #10b981;
            box-shadow: 0 0 8px #10b981;
        }

        .status-offline {
            background: #ef4444;
            box-shadow: 0 0 8px #ef4444;
        }

        .chat-message {
            margin: 16px 0;
            padding: 16px;
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .chat-message.user {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            border: 1px solid rgba(59, 130, 246, 0.4);
            margin-left: 60px;
        }

        .chat-message.ai {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(0, 255, 255, 0.2) 100%);
            border: 1px solid rgba(0, 255, 255, 0.4);
            margin-right: 60px;
        }

        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '‚óè'; }
            40% { content: '‚óè‚óè'; }
            60% { content: '‚óè‚óè‚óè'; }
            80%, 100% { content: ''; }
        }

        .font-display {
            font-family: 'Cal Sans', sans-serif;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .search-result {
            background: rgba(10, 11, 13, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin: 8px 0;
            transition: all 0.2s ease;
        }

        .search-result:hover {
            border-color: rgba(0, 255, 255, 0.4);
            background: rgba(10, 11, 13, 0.8);
        }
    </style>
</head>
<body class="min-h-screen text-white">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        function LiveExplorer() {
            const [activeView, setActiveView] = useState('chat');
            const [chatMessages, setChatMessages] = useState([]);
            const [currentMessage, setCurrentMessage] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [apiStatus, setApiStatus] = useState('checking');
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [lexiconResults, setLexiconResults] = useState([]);
            const chatInputRef = useRef(null);

            // Check API status on mount
            useEffect(() => {
                checkApiStatus();
                const interval = setInterval(checkApiStatus, 30000); // Check every 30s
                return () => clearInterval(interval);
            }, []);

            const checkApiStatus = async () => {
                try {
                    const response = await fetch('http://127.0.0.1:8787/lexicon/search?q=test');
                    setApiStatus(response.ok ? 'online' : 'offline');
                } catch (error) {
                    setApiStatus('offline');
                }
            };

            const sendMessage = async () => {
                if (!currentMessage.trim()) return;

                const userMessage = {
                    id: Date.now().toString(),
                    type: 'user',
                    content: currentMessage,
                    timestamp: new Date()
                };

                setChatMessages(prev => [...prev, userMessage]);
                setCurrentMessage('');
                setIsLoading(true);

                try {
                    const response = await fetch('http://127.0.0.1:8787/translate/research', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            span_id: '07f94cc1-f652-40d0-95ec-f86ad20228a7',
                            model: 'claude-3-5-sonnet-20241022'
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    const analysisResult = await response.json();
                    
                    let aiResponse = `üî¨ B√ÜKON FL Analysis of "${userMessage.content}":

üéØ Analysis Mode: ${analysisResult.mode}
üìä Tokens Identified: ${analysisResult.tokens?.length || 0}
üîó Model: ${analysisResult.provenance?.model}`;

                    if (analysisResult.tokens && analysisResult.tokens.length > 0) {
                        aiResponse += `\n\nüß© Token Analysis:`;
                        analysisResult.tokens.forEach((token) => {
                            aiResponse += `\n‚Ä¢ ${token.surface} ‚Üí "${token.gloss}" (${Math.round(token.confidence * 100)}% confidence)`;
                            aiResponse += `\n  üìö Source: ${token.sources?.join(', ') || 'unknown'}`;
                            aiResponse += `\n  üîç Method: ${token.method}`;
                        });
                    }

                    if (analysisResult.unresolved && analysisResult.unresolved.length > 0) {
                        aiResponse += `\n\n‚ùì Unresolved tokens: ${analysisResult.unresolved.join(', ')}`;
                    }

                    aiResponse += `\n\nüìù Notes: ${analysisResult.notes}`;

                    const aiMessage = {
                        id: (Date.now() + 1).toString(),
                        type: 'ai',
                        content: aiResponse,
                        timestamp: new Date()
                    };

                    setChatMessages(prev => [...prev, aiMessage]);
                } catch (error) {
                    console.error('API Error:', error);
                    
                    const errorMessage = {
                        id: (Date.now() + 1).toString(),
                        type: 'ai',
                        content: `‚ö†Ô∏è API Connection Error: ${error.message}

üîß Troubleshooting:
‚Ä¢ Backend API may be offline
‚Ä¢ Check that server is running on port 8787
‚Ä¢ Verify Docker services are running

üí° Status: Backend should be accessible at http://127.0.0.1:8787`,
                        timestamp: new Date()
                    };
                    setChatMessages(prev => [...prev, errorMessage]);
                } finally {
                    setIsLoading(false);
                }
            };

            const searchAnaIndex = async () => {
                if (!searchQuery.trim()) return;
                
                try {
                    const response = await fetch(`http://127.0.0.1:8787/anas-index/search?q=${encodeURIComponent(searchQuery)}`);
                    const results = await response.json();
                    setSearchResults(results || []);
                } catch (error) {
                    console.error('Ana Index search error:', error);
                    setSearchResults([]);
                }
            };

            const searchLexicon = async () => {
                if (!searchQuery.trim()) return;
                
                try {
                    const response = await fetch(`http://127.0.0.1:8787/lexicon/search?q=${encodeURIComponent(searchQuery)}`);
                    const results = await response.json();
                    setLexiconResults(results || []);
                } catch (error) {
                    console.error('Lexicon search error:', error);
                    setLexiconResults([]);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (activeView === 'chat') {
                        sendMessage();
                    } else if (activeView === 'ana-index') {
                        searchAnaIndex();
                    } else if (activeView === 'lexicon') {
                        searchLexicon();
                    }
                }
            };

            const renderChat = () => (
                <div className="h-full flex flex-col">
                    <div className="flex-1 overflow-y-auto p-6 space-y-4">
                        {chatMessages.length === 0 && (
                            <div className="text-center text-gray-400 py-16">
                                <h3 className="text-xl font-display mb-4">üî¨ FL Research Console</h3>
                                <p className="mb-2">Enter FL text for live analysis with source attribution</p>
                                <p className="text-sm opacity-70">Powered by Claude API ‚Ä¢ Real-time lexicon lookup</p>
                            </div>
                        )}
                        
                        {chatMessages.map((message) => (
                            <div key={message.id} className={`chat-message ${message.type}`}>
                                <div className="flex justify-between items-start mb-2">
                                    <span className="text-xs opacity-70 font-mono">
                                        {message.type === 'user' ? 'USER' : 'B√ÜKON AI'}
                                    </span>
                                    <span className="text-xs opacity-50 font-mono">
                                        {message.timestamp.toLocaleTimeString()}
                                    </span>
                                </div>
                                <div>{message.content}</div>
                            </div>
                        ))}
                        
                        {isLoading && (
                            <div className="chat-message ai">
                                <div className="flex justify-between items-start mb-2">
                                    <span className="text-xs opacity-70 font-mono">B√ÜKON AI</span>
                                    <span className="text-xs opacity-50 font-mono">Analyzing...</span>
                                </div>
                                <div>
                                    üî¨ Analyzing FL text with live API<span className="loading-dots"></span>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <div className="p-6 border-t border-gray-700">
                        <div className="flex space-x-4">
                            <input
                                ref={chatInputRef}
                                type="text"
                                value={currentMessage}
                                onChange={(e) => setCurrentMessage(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="Enter FL text for analysis... (e.g., aeshafaf ararth)"
                                className="cyber-input flex-1"
                                disabled={isLoading}
                            />
                            <button
                                onClick={sendMessage}
                                disabled={isLoading || !currentMessage.trim()}
                                className="cyber-button px-8"
                            >
                                {isLoading ? 'Analyzing...' : 'Analyze'}
                            </button>
                        </div>
                    </div>
                </div>
            );

            const renderAnaIndex = () => (
                <div className="h-full flex flex-col p-6">
                    <div className="mb-6">
                        <h2 className="text-2xl font-display mb-4">Ana's Index Search</h2>
                        <div className="flex space-x-4">
                            <input
                                type="text"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="Search FL documents..."
                                className="cyber-input flex-1"
                            />
                            <button onClick={searchAnaIndex} className="cyber-button px-8">
                                Search
                            </button>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto">
                        {searchResults.length === 0 ? (
                            <div className="text-center text-gray-400 py-16">
                                <p>Search Ana's Index for FL documents and articles</p>
                                <p className="text-sm opacity-70 mt-2">21.9MB database ‚Ä¢ Full-text search</p>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {searchResults.map((result, index) => (
                                    <div key={index} className="search-result">
                                        <h3 className="font-display text-lg mb-2 text-cyan-300">{result.title}</h3>
                                        <p className="text-sm text-gray-400 mb-2">
                                            By {result.author} ‚Ä¢ {result.date_posted} ‚Ä¢ Tags: {result.tags}
                                        </p>
                                        {result.english_text && (
                                            <p className="text-sm mb-2 opacity-80">{result.english_text.slice(0, 200)}...</p>
                                        )}
                                        {result.full_text && (
                                            <details className="mt-2">
                                                <summary className="cursor-pointer text-cyan-400 text-sm">View FL Text</summary>
                                                <pre className="text-xs bg-black/30 p-3 mt-2 rounded overflow-x-auto">
                                                    {result.full_text.slice(0, 500)}...
                                                </pre>
                                            </details>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );

            const renderLexicon = () => (
                <div className="h-full flex flex-col p-6">
                    <div className="mb-6">
                        <h2 className="text-2xl font-display mb-4">FL Lexicon</h2>
                        <div className="flex space-x-4">
                            <input
                                type="text"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="Search FL terms..."
                                className="cyber-input flex-1"
                            />
                            <button onClick={searchLexicon} className="cyber-button px-8">
                                Search
                            </button>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto">
                        {lexiconResults.length === 0 ? (
                            <div className="text-center text-gray-400 py-16">
                                <p>Search the FL lexicon for term definitions</p>
                                <p className="text-sm opacity-70 mt-2">Confidence-scored translations</p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {lexiconResults.map((result, index) => (
                                    <div key={index} className="search-result">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <span className="font-display text-lg text-cyan-300">{result.surface_form}</span>
                                                <span className="mx-3 text-gray-500">‚Üí</span>
                                                <span className="text-white">{result.gloss}</span>
                                            </div>
                                            <span className="text-sm text-purple-400">
                                                {Math.round(result.confidence * 100)}%
                                            </span>
                                        </div>
                                        {result.pos && (
                                            <p className="text-sm text-gray-400 mt-1">
                                                Part of speech: {result.pos}
                                            </p>
                                        )}
                                        <p className="text-xs text-gray-500 mt-1">
                                            Source: {result.source_ref}
                                        </p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );

            const renderExternal = () => (
                <div className="h-full flex flex-col p-6">
                    <h2 className="text-2xl font-display mb-4">External Search</h2>
                    <div className="flex-1 bg-black/20 rounded-lg border border-gray-700 p-4">
                        <iframe 
                            src="https://forgotten-languages-search.streamlit.app/" 
                            className="w-full h-full rounded border-0"
                            title="External FL Search"
                        />
                    </div>
                </div>
            );

            const views = {
                'chat': renderChat,
                'ana-index': renderAnaIndex,
                'lexicon': renderLexicon,
                'external': renderExternal
            };

            return (
                <div className="h-screen flex">
                    {/* Sidebar */}
                    <div className="w-80 cyber-border m-4 mr-0 p-6">
                        <div className="mb-8">
                            <h1 className="text-2xl font-display font-bold text-white mb-2">
                                B√ÜKON RZRCT
                            </h1>
                            <p className="text-sm text-gray-400 font-mono">
                                Live FL Research Console
                            </p>
                            <div className="mt-3 flex items-center text-xs">
                                <span className={`status-indicator ${apiStatus === 'online' ? 'status-online' : 'status-offline'}`}></span>
                                <span className={apiStatus === 'online' ? 'text-green-400' : 'text-red-400'}>
                                    {apiStatus === 'online' ? 'API Online' : 'API Offline'}
                                </span>
                                <span className="text-gray-500 ml-2">‚Ä¢ Port 8787</span>
                            </div>
                        </div>

                        <nav className="space-y-2">
                            {[
                                { id: 'chat', label: 'üî¨ FL Analysis', desc: 'Live translation with AI' },
                                { id: 'ana-index', label: 'üìö Ana\'s Index', desc: 'FL document database' },
                                { id: 'lexicon', label: 'üìñ Lexicon', desc: 'Term definitions' },
                                { id: 'external', label: 'üåê External Search', desc: 'Community resources' }
                            ].map(item => (
                                <div
                                    key={item.id}
                                    className={`sidebar-item ${activeView === item.id ? 'active' : ''}`}
                                    onClick={() => setActiveView(item.id)}
                                >
                                    <div>
                                        <div className="font-medium">{item.label}</div>
                                        <div className="text-xs opacity-70">{item.desc}</div>
                                    </div>
                                </div>
                            ))}
                        </nav>

                        <div className="mt-8 p-4 bg-black/30 rounded-lg border border-gray-700">
                            <h3 className="font-display text-sm mb-2 text-cyan-300">Quick Test</h3>
                            <p className="text-xs text-gray-400 mb-2">Try these FL terms:</p>
                            <div className="space-y-1 text-xs font-mono">
                                <div className="text-purple-300">aeshafaf ararth</div>
                                <div className="text-purple-300">nebeder</div>
                                <div className="text-purple-300">mesen</div>
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 cyber-border m-4 ml-2">
                        {views[activeView]()}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<LiveExplorer />, document.getElementById('root'));
    </script>
</body>
</html>
